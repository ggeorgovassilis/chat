<!DOCTYPE html>
<html>
<head>
<title>Chat Demo by George Georgovassilis</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

    <script src="resources/jquery-ui-1.9.2/js/jquery-1.8.3.js"></script>
    <link href="resources/bootstrap/css/bootstrap.css" rel="stylesheet">
    <script src="resources/bootstrap/js/bootstrap.js"></script>
    <link href="resources/bootstrap-editable/css/bootstrap-editable.css" rel="stylesheet">
    <script src="resources/bootstrap-editable/js/bootstrap-editable.js"></script>
    <link href="resources/css/chat.css" rel="stylesheet">

</head>
<body>
<div id="loginarea">
<a href="#" id="username" data-emptytext="Enter login" data-type="text" data-send="always" data-showbuttons="false" data-pk="1" data-url="/chat/ajax/users/logon" data-original-title="Enter username"></a>
</div>
<hr/>
<div class=section-header>Online users</div>
<select id="onlineusers"></select>
<div id="chatwindow"></div>
<div class="keyboard-section">
<input id="input" type="text"/>
</div>
<script type="text/javascript">
$(function(){
	$.fn.editable.defaults.mode = 'inline';
	$("#username").editable({
		success:function(){
			updateOnlineUsers();
		}
	});
	
	window.setTimeout("sync()",1000);
});

function getCurrentUserLogin(){
	return $("#username").text();
}

function getCurrentChatPartner(){
	return $("#onlineusers option:selected").text();
}

function updateOnlineUsers(){
	$.ajax({
		dataType: "json",
		url: "ajax/users/list",
		success: function(data){
			var onlineusers = $("#onlineusers");
			onlineusers.empty();
			for (var i=0;i<data.activeUsers.length;i++){
				var line = $("<option></option>");
				line.text(data.activeUsers[i]);
				line.attr("value",data.activeUsers[i]);
				console.log(data.activeUsers[i]);
				onlineusers.append(line);
			}
			if (data.activeUsers.length == 0){
				onlineusers.append("<div class=message>No users online</div>");
			}
		}
		});
}

function sendTextToChat(){
	var line = $("#input").val();
	var recipient = getCurrentChatPartner();
	$.ajax({
		dataType: "json",
		type:"POST",
		url: "ajax/users/"+recipient+"/messages/from/"+getCurrentUserLogin()+"?text="+line,
		success: function(data){
		}
		});
}

function showChatWith(user){
	var conversation = session[user]||{lastReadMessageId:-1};
	session[user] = conversation;	
	$.ajax({
		dataType: "json",
		url: "ajax/users/"+getCurrentUserLogin()+"/messages/from/"+user+"?lastReadMessageId="+conversation.lastReadMessageId,
		success: function(data){
			var wnd = $("#chatwindow");
			wnd.empty();
			for (var i=0;i<data.list.length;i++){
				var msg = data.list[i];
				var line = $("<div></div>");
				line.attr("id", msg.id);
				line.text(msg.sender+">"+msg.text);
				wnd.append(line);
				conversation.lastReadMessageId = Math.max(conversation.lastReadMessageId, msg.id);				
			}
		}
		});
}

function sync(){
	showChatWith(getCurrentChatPartner());
	updateOnlineUsers();
}

$("#input").keypress(function(e){
	 if(e.which === 13){
		 sendTextToChat();
	 }
});

$("#onlineusers").change(function(e){
	var user = $("#onlineusers option:selected").text();
	showChatWith(user);
});

var session = {};
</script>
</body>
</html>